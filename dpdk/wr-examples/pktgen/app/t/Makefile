# Unit tests and integration tests for Pktgen-DPDK
#
# The test harness used by the unit tests is libtap, obtained from
# <https://github.com/zorgnax/libtap>.


### Environment checks
ifeq ($(RTE_SDK),)
$(error "Please define RTE_SDK environment variable")
endif

ifeq ($(wildcard ../build/app/pktgen),)
$(error "Please compile Pktgen first")
endif

ifeq ($(RTE_TARGET),)
RTE_TARGET := x86_64-wr-linuxapp-gcc
$(warning "RTE_TARGET is not defined, using default value $(RTE_TARGET)")
endif

# build/ holds the .o files from our tests.
# build/app/ holds the .o files from the Pktgen C files needed by the tests.
# They go in a separate location, so they can be easily distinguished and get
# a separate compile command (for example to enable code coverage functions).
$(shell mkdir -p build/app/)

# lcov/ holds the coverage data, lcov/html/ contains the HTML coverage report.
$(shell mkdir -p lcov/html)


### Use DPDK CC, CFLAGS, ...
include $(RTE_SDK)/mk/rte.vars.mk


### Extra flags for test compilation and linking
TEST_CFLAGS  := -include libtap/tap.h -include helpers/test_helpers.h -I.. -Wall -Werror
TEST_LDFLAGS :=

### Extra flags for application source files
# Optimization is disabled and code coverage instrumentation is enabled. This
# allows for test coverage reports.
APP_CFLAGS := -O0 --coverage -g3
APP_LDFLAGS := -O0 --coverage

### Options for prove command. These can be specified on the commandline
# too.
#PROVE_OPTS = -v


### Tests to build/run.
# Tests can be either C files (code unit tests) or Perl scripts (functionality
# and integration testing).
C_TESTS  := $(patsubst %.c, %, $(wildcard *.t.c))
PL_TESTS := $(wildcard *.pl.t)

# Sort the filenames, so execution order is maintained.
ALL_TESTS := $(sort $(C_TESTS) $(PL_TESTS))


### Make targets
.PHONY: all tests check test clean

all: libtap/libtap.a tests

tests: $(ALL_TESTS) lcov/coverage-base.info


# Prepend ./ to test filenames. If . is not in $PATH, prove will fail otherwise.
check test: all
	-prove $(PROVE_OPTS) $(ALL_TESTS:%=./%)

# Generate test coverage report in HTML
cover: $(C_TESTS) lcov/coverage-base.info
	-prove $(PROVE_OPTS) $(C_TESTS:%=./%)
	cp lcov/coverage-base.info lcov/coverage-total.info
	lcov -c --base-directory ./ --derive-func-data -d build/app/ -o lcov/coverage-test.info
	lcov --base-directory ./ --derive-func-data -o lcov/coverage-total.info -a lcov/coverage-base.info -a lcov/coverage-test.info
	lcov -o lcov/coverage-filtered.info -e lcov/coverage-total.info "$$RTE_SDK/wr-examples/pktgen/*"
	genhtml -o lcov/html/ -s --legend lcov/coverage-filtered.info

clean:
	rm -rf *.o libtap/*.o libtap/libtap.a build/ lcov/ $(C_TESTS)

# Test dependencies. The dependency files contain make targets, so they must be
# included after the default make target (all) is set.
-include $(C_TESTS:%=build/%.d)

build/%.d: %.c helpers/makedeps
	helpers/makedeps $< $@



### File recipes
## libtap library
libtap/libtap.a: libtap/tap.o
	$(AR) rcs $@ $(filter %.o, $^)

## Test object files
# $($@_CFLAGS) are extra CFLAGS for a specific test .o file. These CFLAGS are
# generated by the makedeps script and contain "-include ../<foo>.h" for every
# SOURCE entry <foo> specified in the test where ../<foo.h> exists.
$(patsubst %, build/%.o, $(C_TESTS)): build/%.o: %.c libtap/tap.h
	$(CC) $(CFLAGS) $(TEST_CFLAGS) $($@_CFLAGS) -c $< -o $@

## Application object files
build/app/%.o: ../%.c
	$(CC) $(CFLAGS) $(APP_CFLAGS) -c $< -o $@

## Test executables
$(C_TESTS): %: build/%.o libtap/libtap.a
	$(CC) $(LDFLAGS) $(TEST_LDFLAGS) $(APP_LDFLAGS) $^ -o $@

## Coverage files
lcov/coverage-base.info: $(C_TESTS)
	lcov -c -i --base-directory ./ -d build/app/ -o $@
